# å–®å…ƒæ¸¬è©¦èªªæ˜æ–‡ä»¶

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æª”èªªæ˜ BI Dashboard Backend ç³»çµ±ä¸­å–®å…ƒæ¸¬è©¦çš„æ¸¬è©¦ç¯„åœã€æ¸¬è©¦ç­–ç•¥å’Œæ¸¬è©¦é‡é»ã€‚

## ğŸ¯ æ¸¬è©¦ç›®æ¨™

ç¢ºä¿ç³»çµ±çš„æ ¸å¿ƒåŠŸèƒ½ã€æ¥­å‹™é‚è¼¯å’Œ API ç«¯é»çš„æ­£ç¢ºæ€§ã€ç©©å®šæ€§å’Œå®‰å…¨æ€§ã€‚

## ğŸ“ æ¸¬è©¦å°ˆæ¡ˆçµæ§‹

```
BIDashboardBackend.Tests/
â”œâ”€â”€ Controllers/           # API æ§åˆ¶å™¨æ¸¬è©¦
â”œâ”€â”€ Services/             # æ¥­å‹™é‚è¼¯æœå‹™æ¸¬è©¦
â”œâ”€â”€ Repositories/         # è³‡æ–™å­˜å–å±¤æ¸¬è©¦
â”œâ”€â”€ Utils/               # å·¥å…·é¡æ¸¬è©¦
â””â”€â”€ TestHelpers/         # æ¸¬è©¦è¼”åŠ©å·¥å…·
```

## ğŸ§ª æ¸¬è©¦ç¯„åœ

### 1. æ§åˆ¶å™¨å±¤æ¸¬è©¦ (Controllers)

#### 1.1 AuthController
- **ç™»å…¥åŠŸèƒ½**
  - æœ‰æ•ˆæ†‘è­‰ç™»å…¥æˆåŠŸ
  - ç„¡æ•ˆæ†‘è­‰ç™»å…¥å¤±æ•—
  - ç©ºæ†‘è­‰è™•ç†
  - JWT Token ç”Ÿæˆé©—è­‰

- **ç™»å‡ºåŠŸèƒ½**
  - æˆåŠŸç™»å‡º
  - ç„¡æ•ˆ Token è™•ç†

#### 1.2 UploadsController
- **è³‡æ–™é›†ç®¡ç†**
  - å‰µå»ºè³‡æ–™é›†æˆåŠŸ
  - å‰µå»ºè³‡æ–™é›†å¤±æ•—ï¼ˆé‡è¤‡åç¨±ã€ç„¡æ•ˆåƒæ•¸ï¼‰
  - åˆªé™¤è³‡æ–™é›†æˆåŠŸ
  - åˆªé™¤è³‡æ–™é›†å¤±æ•—ï¼ˆç„¡æ¬Šé™ã€ä¸å­˜åœ¨ï¼‰
  - æ¬Šé™é©—è­‰ï¼ˆåªèƒ½æ“ä½œè‡ªå·±çš„è³‡æ–™é›†ï¼‰

- **æª”æ¡ˆä¸Šå‚³**
  - CSV æª”æ¡ˆä¸Šå‚³æˆåŠŸ
  - ç„¡æ•ˆæª”æ¡ˆæ ¼å¼è™•ç†
  - æª”æ¡ˆå¤§å°é™åˆ¶æª¢æŸ¥
  - ä¸Šå‚³å¤±æ•—è™•ç†

- **æ‰¹æ¬¡ç®¡ç†**
  - åˆªé™¤æ‰¹æ¬¡æˆåŠŸ
  - åˆªé™¤æ‰¹æ¬¡å¤±æ•—ï¼ˆç„¡æ¬Šé™ã€ä¸å­˜åœ¨ï¼‰
  - ETL Job è§¸ç™¼é©—è­‰

- **æ¬„ä½æ˜ å°„**
  - ç²å–æ˜ å°„è³‡è¨Š
  - æ›´æ–°æ˜ å°„æˆåŠŸ
  - ç„¡æ•ˆæ˜ å°„è™•ç†

#### 1.3 MetricsController
- **æŒ‡æ¨™æŸ¥è©¢**
  - ç²å–æ‰€æœ‰æŒ‡æ¨™æˆåŠŸ
  - ç„¡æ•ˆè³‡æ–™é›† ID è™•ç†
  - æ¬Šé™é©—è­‰
  - å¿«å–æ©Ÿåˆ¶é©—è­‰

- **å¿«å–ç®¡ç†**
  - æ¸…é™¤å¿«å–æˆåŠŸ
  - ç„¡æ•ˆè³‡æ–™é›† ID è™•ç†

#### 1.4 MeController
- **ç”¨æˆ¶è³‡è¨Š**
  - ç²å–ç”¨æˆ¶è³‡æ–™é›†åˆ—è¡¨
  - ç„¡æ•ˆç”¨æˆ¶è™•ç†

### 2. æœå‹™å±¤æ¸¬è©¦ (Services)

#### 2.1 AuthService
- **èªè­‰é‚è¼¯**
  - Firebase Token é©—è­‰
  - JWT Token ç”Ÿæˆå’Œé©—è­‰
  - ç”¨æˆ¶è³‡è¨Šæå–
  - éŒ¯èª¤è™•ç†

#### 2.2 IngestService
- **è³‡æ–™é›†ç®¡ç†**
  - å‰µå»ºè³‡æ–™é›†æ¥­å‹™é‚è¼¯
  - åˆªé™¤è³‡æ–™é›†æ¥­å‹™é‚è¼¯
  - åƒæ•¸é©—è­‰
  - æ¬Šé™æª¢æŸ¥

- **æª”æ¡ˆè™•ç†**
  - CSV æª”æ¡ˆè§£æ
  - è³‡æ–™é©—è­‰
  - æ‰¹æ¬¡å‰µå»º
  - æ¬„ä½æ˜ å°„è™•ç†

- **æ‰¹æ¬¡ç®¡ç†**
  - æ‰¹æ¬¡åˆªé™¤é‚è¼¯
  - ETL Job æ’ç¨‹
  - éŒ¯èª¤è™•ç†

#### 2.3 MetricService
- **æŒ‡æ¨™è¨ˆç®—**
  - å¹´é½¡åˆ†å¸ƒè¨ˆç®—
  - æ€§åˆ¥æ¯”ä¾‹è¨ˆç®—
  - ç‡Ÿæ”¶è¶¨å‹¢è¨ˆç®—
  - åœ°å€åˆ†å¸ƒè¨ˆç®—
  - ç”¢å“é¡åˆ¥çµ±è¨ˆ

- **è³‡æ–™è½‰æ›**
  - åŸå§‹è³‡æ–™åˆ°æŒ‡æ¨™çš„è½‰æ›
  - è³‡æ–™æ¨™æº–åŒ–
  - éŒ¯èª¤è³‡æ–™è™•ç†

#### 2.4 JwtTokenService
- **Token ç®¡ç†**
  - Token ç”Ÿæˆ
  - Token é©—è­‰
  - Token éæœŸè™•ç†
  - ç„¡æ•ˆ Token è™•ç†

### 3. è³‡æ–™å­˜å–å±¤æ¸¬è©¦ (Repositories)

#### 3.1 DatasetRepository
- **è³‡æ–™é›†æ“ä½œ**
  - å‰µå»ºè³‡æ–™é›†
  - åˆªé™¤è³‡æ–™é›†ï¼ˆç´šè¯åˆªé™¤ï¼‰
  - æŸ¥è©¢è³‡æ–™é›†
  - æ¬Šé™é©—è­‰

- **æ‰¹æ¬¡æ“ä½œ**
  - å‰µå»ºæ‰¹æ¬¡
  - åˆªé™¤æ‰¹æ¬¡
  - æ‰¹æ¬¡ç‹€æ…‹æ›´æ–°
  - æ‰¹æ¬¡æŸ¥è©¢

- **æ¬„ä½æ“ä½œ**
  - æ¬„ä½å‰µå»º
  - æ¬„ä½æ˜ å°„
  - æ¬„ä½æŸ¥è©¢

- **è³‡æ–™è¡Œæ“ä½œ**
  - å¤§é‡è³‡æ–™æ’å…¥
  - è³‡æ–™æŸ¥è©¢
  - è³‡æ–™åˆªé™¤

#### 3.2 UserRepository
- **ç”¨æˆ¶ç®¡ç†**
  - ç”¨æˆ¶å‰µå»º
  - ç”¨æˆ¶æŸ¥è©¢
  - ç”¨æˆ¶æ›´æ–°

#### 3.3 MetricRepository
- **æŒ‡æ¨™å„²å­˜**
  - æŒ‡æ¨™æ’å…¥
  - æŒ‡æ¨™æ›´æ–°
  - æŒ‡æ¨™æŸ¥è©¢
  - æŒ‡æ¨™åˆªé™¤

### 4. å·¥å…·é¡æ¸¬è©¦ (Utils)

#### 4.1 Json å·¥å…·
- **JSON è™•ç†**
  - åºåˆ—åŒ–
  - ååºåˆ—åŒ–
  - éŒ¯èª¤è™•ç†

## ğŸ¯ æ¸¬è©¦é‡é»

### 1. å®‰å…¨æ€§æ¸¬è©¦
- **èªè­‰å’Œæˆæ¬Š**
  - JWT Token é©—è­‰
  - ç”¨æˆ¶æ¬Šé™æª¢æŸ¥
  - è·¨ç”¨æˆ¶è³‡æ–™å­˜å–é˜²è­·

- **è¼¸å…¥é©—è­‰**
  - SQL æ³¨å…¥é˜²è­·
  - XSS é˜²è­·
  - åƒæ•¸é©—è­‰

### 2. æ¥­å‹™é‚è¼¯æ¸¬è©¦
- **è³‡æ–™å®Œæ•´æ€§**
  - å¤–éµç´„æŸ
  - ç´šè¯åˆªé™¤
  - äº‹å‹™è™•ç†

- **è³‡æ–™è½‰æ›**
  - æ€§åˆ¥æ¨™æº–åŒ–
  - æ—¥æœŸæ ¼å¼è™•ç†
  - æ•¸å€¼è¨ˆç®—

### 3. éŒ¯èª¤è™•ç†æ¸¬è©¦
- **ç•°å¸¸æƒ…æ³**
  - ç¶²è·¯éŒ¯èª¤
  - è³‡æ–™åº«éŒ¯èª¤
  - æª”æ¡ˆè™•ç†éŒ¯èª¤

- **é‚Šç•Œæ¢ä»¶**
  - ç©ºè³‡æ–™è™•ç†
  - æ¥µå¤§å€¼è™•ç†
  - ç„¡æ•ˆæ ¼å¼è™•ç†

### 4. æ•ˆèƒ½æ¸¬è©¦
- **å¤§é‡è³‡æ–™è™•ç†**
  - æ‰¹æ¬¡æ’å…¥æ•ˆèƒ½
  - æŸ¥è©¢æ•ˆèƒ½
  - è¨˜æ†¶é«”ä½¿ç”¨

## ğŸ“Š æ¸¬è©¦è¦†è“‹ç‡ç›®æ¨™

- **ç¨‹å¼ç¢¼è¦†è“‹ç‡**ï¼šâ‰¥ 80%
- **åˆ†æ”¯è¦†è“‹ç‡**ï¼šâ‰¥ 75%
- **é—œéµæ¥­å‹™é‚è¼¯**ï¼š100%

## ğŸ› ï¸ æ¸¬è©¦å·¥å…·

- **æ¸¬è©¦æ¡†æ¶**ï¼šxUnit
- **Mock æ¡†æ¶**ï¼šMoq
- **æ–·è¨€åº«**ï¼šFluentAssertions
- **æ¸¬è©¦è³‡æ–™åº«**ï¼šIn-Memory Database
- **æ•´åˆæ¸¬è©¦**ï¼šASP.NET Core Test Host

## ğŸ“ æ¸¬è©¦å‘½åè¦ç¯„

```csharp
// æ ¼å¼ï¼šMethodName_Scenario_ExpectedResult
[Fact]
public async Task DeleteDatasetAsync_WithValidInput_ShouldReturnTrue()

[Fact]
public async Task DeleteDatasetAsync_WithInvalidDatasetId_ShouldThrowArgumentException()

[Fact]
public async Task DeleteDatasetAsync_WithUnauthorizedUser_ShouldReturnFalse()
```

## ğŸš€ åŸ·è¡Œæ¸¬è©¦

```bash
# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
dotnet test

# åŸ·è¡Œç‰¹å®šæ¸¬è©¦é¡åˆ¥
dotnet test --filter "IngestServiceTests"

# ç”Ÿæˆæ¸¬è©¦è¦†è“‹ç‡å ±å‘Š
dotnet test --collect:"XPlat Code Coverage"

# åŸ·è¡Œæ¸¬è©¦ä¸¦ç”Ÿæˆè©³ç´°å ±å‘Š
dotnet test --logger "trx;LogFileName=test-results.trx"
```

## ğŸ“‹ æ¸¬è©¦æª¢æŸ¥æ¸…å–®

### æ–°å¢åŠŸèƒ½æ™‚
- [ ] æ§åˆ¶å™¨æ¸¬è©¦
- [ ] æœå‹™å±¤æ¸¬è©¦
- [ ] è³‡æ–™å­˜å–å±¤æ¸¬è©¦
- [ ] éŒ¯èª¤è™•ç†æ¸¬è©¦
- [ ] æ¬Šé™é©—è­‰æ¸¬è©¦
- [ ] é‚Šç•Œæ¢ä»¶æ¸¬è©¦

### ä¿®æ”¹ç¾æœ‰åŠŸèƒ½æ™‚
- [ ] ç›¸é—œæ¸¬è©¦æ›´æ–°
- [ ] å›æ­¸æ¸¬è©¦åŸ·è¡Œ
- [ ] æ¸¬è©¦è¦†è“‹ç‡æª¢æŸ¥

## ğŸ”„ æŒçºŒæ•´åˆ

- **è‡ªå‹•åŒ–æ¸¬è©¦**ï¼šæ¯æ¬¡æäº¤è‡ªå‹•åŸ·è¡Œ
- **æ¸¬è©¦å ±å‘Š**ï¼šç”Ÿæˆè©³ç´°çš„æ¸¬è©¦å ±å‘Š
- **è¦†è“‹ç‡å ±å‘Š**ï¼šç›£æ§æ¸¬è©¦è¦†è“‹ç‡
- **å“è³ªé–˜é–€**ï¼šæ¸¬è©¦å¤±æ•—æ™‚é˜»æ­¢éƒ¨ç½²

## ğŸ“š æ¸¬è©¦ç¯„ä¾‹

### æ§åˆ¶å™¨æ¸¬è©¦ç¯„ä¾‹
```csharp
[Fact]
public async Task DeleteDataset_WithValidRequest_ShouldReturnOk()
{
    // Arrange
    var datasetId = 1L;
    _mockService.Setup(x => x.DeleteDatasetAsync(datasetId, It.IsAny<long>()))
               .ReturnsAsync(true);

    // Act
    var result = await _controller.DeleteDataset(datasetId);

    // Assert
    result.Should().BeOfType<OkObjectResult>();
}
```

### æœå‹™å±¤æ¸¬è©¦ç¯„ä¾‹
```csharp
[Fact]
public async Task DeleteDatasetAsync_WithValidInput_ShouldReturnTrue()
{
    // Arrange
    var datasetId = 1L;
    var userId = 1L;
    _mockRepo.Setup(x => x.DeleteDatasetAsync(datasetId, userId))
            .ReturnsAsync(true);

    // Act
    var result = await _service.DeleteDatasetAsync(datasetId, userId);

    // Assert
    result.Should().BeTrue();
    _mockRepo.Verify(x => x.DeleteDatasetAsync(datasetId, userId), Times.Once);
}
```

### Repository æ¸¬è©¦ç¯„ä¾‹
```csharp
[Fact]
public async Task DeleteDatasetAsync_WithValidInput_ShouldReturnTrue()
{
    // Arrange
    var datasetId = 1L;
    var userId = 1L;
    
    // Act
    var result = await _repository.DeleteDatasetAsync(datasetId, userId);

    // Assert
    result.Should().BeTrue();
    // é©—è­‰è³‡æ–™åº«ä¸­çš„è³‡æ–™å·²è¢«åˆªé™¤
}
```

---

**æ³¨æ„**ï¼šæœ¬æ–‡ä»¶æœƒéš¨è‘—ç³»çµ±åŠŸèƒ½çš„å¢åŠ è€ŒæŒçºŒæ›´æ–°ï¼Œç¢ºä¿æ¸¬è©¦ç¯„åœçš„å®Œæ•´æ€§å’Œæº–ç¢ºæ€§ã€‚

**æœ€å¾Œæ›´æ–°**ï¼š2024å¹´1æœˆ
**ç‰ˆæœ¬**ï¼š1.0
